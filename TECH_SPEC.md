# Техническая спецификация

Этот документ описывает архитектурные решения и технические детали, использованные при создании разговорного помощника по покупкам.

## Архитектурные решения

-   **Монолитная архитектура**: Вся основная логика приложения заключена в одном файле (`advisor.py`) для простоты и удобства развертывания.
-   **Разделение логики**: Несмотря на монолитность, проект имеет четкое разделение на компоненты:
    -   `advisor.py`: Основной файл, содержащий UI и оркестрацию.
    -   `retrieval.py`: Модуль, отвечающий за извлечение и фильтрацию данных.
    -   `prompts.py`: Хранит все системные промпты и примеры для LLM.
    -   `tests/`: Содержит модульные тесты.
-   **Использование Pydantic**: Все модели данных (продукты, варианты, предпочтения) определены с использованием Pydantic для строгой типизации и валидации, а также для определения схем инструментов, передаваемых в LLM.
-   **Многоступенчатая обработка запроса**:
    1.  **Определение языка**: Сначала определяется язык запроса (русский/английский) для генерации ответа на том же языке.
    2.  **Извлечение предпочтений**: Система извлекает предпочтения пользователя (бренд, цена, характеристики), используя динамически создаваемый список известных брендов из каталога, чтобы избежать ложных срабатываний.
    3.  **Классификация намерения**: Запрос классифицируется как поиск, сравнение или общий вопрос.
-   **Retrieval-Augmented Generation (RAG)**:
    -   Для ответов на вопросы, требующие данных, LLM определяет, какие фильтры применить, и вызывает инструмент `ProductSearchTool`.
    -   Результаты поиска из `retrieval.py` передаются в LLM для генерации ответа на языке пользователя.

## Технологический стек

-   **Python >= 3.10**: Современная версия Python.
-   **Streamlit**: Для создания интерактивного веб-интерфейса.
-   **OpenAI API**: Используются модели `gpt-4.1-mini` для основной логики и `gpt-4.1` для автоматического оценивания ассистента. Температура всех вызовов установлена на `0.0` для детерминированных ответов.
-   **Pydantic**: Для валидации данных и создания схем.
-   **Rapidfuzz**: Для нечеткого поиска и исправления опечаток.
-   **Pytest**: Для написания и запуска модульных тестов.

## Обработка опечаток и Поиск

-   Для обработки опечаток и текстовых запросов используется продвинутый нечеткий поиск из библиотеки `rapidfuzz` (скоринг `WRatio`).
-   Поисковый запрос (`query`) не является жестким фильтром, а используется для ранжирования релевантности, что делает поиск более гибким.
-   Фильтрация по бренду, напротив, использует точное совпадение для надежности.

## Управление состоянием и историей

-   История диалога и предпочтения пользователя хранятся в состоянии сессии Streamlit (`st.session_state`).
-   Для предотвращения переполнения контекстного окна, история диалога обрезается до последних 10 сообщений.
-   API ключ OpenAI безопасно управляется с помощью Streamlit Secrets.
